<!DOCTYPE html>
<html>
	<head>
		<title>H5神庙逃亡</title>
		<meta charset="UTF-8">
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, minimal-ui">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="apple-touch-fullscreen" content="yes" />
		<meta name="HandheldFriendly" content="true" />
		<meta name="mobile-web-app-capable" content="yes">
		<!-- Web3.js库 -->
		<script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>
		<script type="text/javascript" src="./js/game.js"></script>
		<script src="game.js"></script>
		<!-- 钱包相关脚本 -->
		<script type="text/javascript" src="./js/api-service.js"></script>
		<script type="text/javascript" src="./js/wallet.js"></script>
		<script type="text/javascript" src="./js/wallet-progress.js"></script>
		<script type="text/javascript" src="./js/game-config.js"></script>
		<script type="text/javascript" src="./js/wallet-game-integration.js"></script>
		<script type="text/javascript" src="./js/game-status-panel.js"></script>
		<script type="text/javascript" src="./js/debug-tools.js"></script>
		<script type="text/javascript" src="./js/play-button-interceptor.js"></script>
		<script type="text/javascript" src="./js/token-exchange.js"></script>

		<!-- 配置补丁，禁用不必要的网络请求 -->
		<script type="text/javascript" src="./js/config-patch.js"></script>
		<style>
			#container { background: #000000; width: 100%; height: 100%; display: none; /* 默认隐藏，登录后显示 */ }

			html, body {
				background: #000000;
				margin: 0;
				padding: 0;
				width: 100%;
				height: 100%;
				touch-action: none;
				user-select: none;
				-ms-touch-action: none;
				-moz-user-select: none;
				-webkit-touch-callout: none;
				-webkit-user-select: none;
				-ms-user-select: none;
				-khtml-user-select: none;
				-webkit-tap-highlight-color: rgba(0, 0, 0, 0);
			}

			body {
				overflow: hidden;
			}

			canvas {
				touch-action-delay: none;
				touch-action: none;
				-ms-touch-action: none;
			}

			#info {
				position: absolute;
				top: 0px; width: 100%;
				color: #ffffff;
				padding: 5px;
				font-family:Monospace;
				font-size:13px;
				font-weight: bold;
				text-align:center;
			}

			a {
				color: #ffffff;
			}

			/* 钱包按钮样式 */
			.wallet-button {
				background-color: #f5a623;
				color: white;
				border: none;
				padding: 10px 15px;
				border-radius: 5px;
				cursor: pointer;
				font-weight: bold;
			}
			.wallet-button:hover {
				background-color: #e69c1e;
			}
		</style>
	</head>
	<body>
		<div id="container"></div>
		<script type="text/javascript">
		var SpilData = {
			id: '576742227280298086',
			pauseGame: function() {
				if (typeof GEMIOLI !== 'undefined' && GEMIOLI.Application)
					GEMIOLI.Application.dispatchEvent({type: 'blur'});
			},
			resumeGame: function() {
				if (typeof GEMIOLI !== 'undefined' && GEMIOLI.Application)
					GEMIOLI.Application.dispatchEvent({type: 'focus'});
			},
			onLoad: function(callback) {
				if (SpilData.apiInstance)
					callback();
				else
					this.callbacks.push(callback);
			},
			callbacks: []
		};
		GameAPI.loadAPI (function (apiInstance) {
			if (window.console && window.console.log) {
				console.log('GameAPI version ' + apiInstance.version + ' loaded!');
			}
			SpilData.apiInstance = apiInstance;
			SpilData.moreGamesAction = apiInstance.Branding.getLink('more_games').action;
			SpilData.logoData = apiInstance.Branding.getLogo();
			for (var i = 0 ; i < SpilData.callbacks.length ; ++i) {
				SpilData.callbacks[i].call(SpilData);
			}
			SpilData.callbacks = [];
		}, SpilData);
		window.addEventListener('scroll', function () {
			if (document.activeElement === document.body && window.scrollY > 0) {
				document.body.scrollTop = 0;
			}
		}, true);

		// 在页面加载完成后初始化钱包管理器
		window.addEventListener('DOMContentLoaded', function() {
			console.log('页面加载完成，初始化组件...');

			// 设置API服务基础URL
			ApiService.setBaseUrl('http://localhost:3000/api');

			// 初始化钱包进度管理器
			WalletProgress.init();

			// 初始化钱包管理器
			WalletManager.init();

			// 初始化钱包游戏集成
			WalletGameIntegration.init();

			// 初始化游戏状态面板
			GameStatusPanel.init();

			// 初始化代币兑换模块
			TokenExchange.init();

			// 添加一个延迟检查，确保在所有组件初始化后检查金币数据
			setTimeout(async function() {
				console.log('延迟检查金币数据...');
				if (WalletManager.isConnected()) {
					// 显示所有localStorage数据
					DebugTools.showAllLocalStorage();

					// 更新状态面板
					GameStatusPanel.updatePanel();

					// 测试API连接
					const connected = await ApiService.testConnection();
					console.log('API连接测试结果:', connected ? '成功' : '失败');
					WalletProgress.setUseApi(connected);

					if (connected) {
						try {
							// 确保用户数据存在
							const walletAddress = WalletManager.getAccount();
							console.log('当前钱包地址:', walletAddress);

							if (!walletAddress) {
								console.error('钱包地址为空，无法保存初始用户数据');
								return;
							}

							// 首先检查用户数据是否已存在
							console.log('检查用户数据是否已存在...');
							const existingUserData = await ApiService.getUserData(walletAddress);

							// 如果用户数据不存在或为空对象，则创建新用户数据
							if (!existingUserData || Object.keys(existingUserData).length === 0) {
								console.log('用户数据不存在，创建新用户数据...');

								// 使用API服务创建新用户数据
								console.log('使用API服务创建新用户数据...');
								const createUserDataResponse = await ApiService.createUserData(walletAddress);
								console.log('创建新用户数据结果:', createUserDataResponse);

								// 保存初始用户数据
								const initialData = {
									coins: 0,          // 当前可用金币
									highScore: 0,      // 累计获得金币
									lastScore: 0,      // 历史最高得分
									progress: {
										level: 1,
										distance: 0
									},
									achievements: [],
									lastUpdated: new Date().toISOString()
								};

								console.log('保存初始用户数据:', initialData);
								const saved = await ApiService.saveUserData(walletAddress, initialData);
								console.log('初始用户数据保存结果:', saved ? '成功' : '失败');
							} else {
								console.log('用户数据已存在，不创建新数据:', existingUserData);
							}

							// 再次检查用户数据是否存在
							setTimeout(async () => {
								try {
									const userData = await ApiService.getUserData(walletAddress);
									console.log('获取用户数据结果:', userData);

									// 检查data目录
									const checkDataDir = await fetch('http://localhost:3000/check-data-dir');
									console.log('检查data目录结果:', await checkDataDir.text());
								} catch (e) {
									console.error('检查用户数据时出错:', e);
								}
							}, 1000);
						} catch (error) {
							console.error('保存初始用户数据时出错:', error);
						}
					}
				}
			}, 1000);
		});
		</script>

	</body>
</html>
